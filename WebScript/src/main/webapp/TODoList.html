<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>할일 목록</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div id="main" class="container mt-5 mb-3">
        <h3 class="mb-3">📝TODO List</h3>
        <input id="list-item" type="text" placeholder="할일을 입력하세요" required />
        <button id="btn-add" class="btn btn-primary btn-sm align-top" type="button" title="할일 추가">
        추가
        </button>
        <div id="content" class="mt-3">
        <!-- 여기에 추가시킴 -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">
    	let content = document.getElementById("content");
    	let inputListItem = document.getElementById("list-item"); //입력값 읽어오는데 필요
    	// 추가버튼 요소객체 주소(참조)변수에 저장
    	let btnAdd = document.getElementById("btn-add");// 버튼에 이벤트 등록
    	const ul = document.createElement("ul"); // 미리 생성하고 li만 추가
		ul.className = "list-group"; //-> 부트스트랩 list그룹 적용
		
		//로컬스토리지에는 문자열만 저장이 가능하다! 
		//-> (객체 또는 배열은) JSON으로 변환해야함 JSON.stringify()
		// 꺼내서 쓸 땐 그 반대 JSON 문자열-> 객체/배열로 변환 JSON.parse()
		//로컬스토리지 로드
		const toDoList= JSON.parse(localStorage.getItem("toDoList")) || [];
    	//로컬스토리지에서 키가 todolist를 찾는데 없으면 빈배열로(객체배열사용)
    	
    	//화면에 뿌리기 - 로컬스토리지 저장된걸 화면에 뿌림
        function writeToDo() {
            ul.innerHTML = ""; // 기존 화면 초기화
            toDoList.forEach(item => {
                const li = document.createElement("li");
                li.className = "list-group-item";
                li.id = item.liid;
        
                const checkBox = document.createElement("input");
                checkBox.type = "checkbox";
                checkBox.className = "form-check-input me-1";
                checkBox.checked = item.done; // 로컬스토리지에서 체크 여부 적용
        
                const label = document.createElement("label");
                label.className = "form-check-label ms-1";
                label.innerHTML = item.text;
        
                // 체크 상태 스타일 적용
                if(item.done){
                    label.style.color = "gray";
                    label.style.textDecoration = "line-through";
                }
        
                // 수정 버튼
                const btnUpdate = document.createElement("button");
                btnUpdate.className = "btn btn-sm btn-outline-info ms-2 me-1";
                btnUpdate.innerHTML = "수정";
        
                // 삭제 버튼
                const btnDelete = document.createElement("button");
                btnDelete.className = "btn btn-sm btn-outline-danger";
                btnDelete.innerHTML = "삭제";
        
                li.appendChild(checkBox);
                li.appendChild(label);
                li.appendChild(btnUpdate);
                li.appendChild(btnDelete);
                ul.appendChild(li);
                
                //수정버튼 이벤트 등록
                btnUpdate.addEventListener("click", () => {
					const btnSuccess = document.createElement("button");
					btnSuccess.className = "btn btn-sm btn-outline-success me-1";
					btnSuccess.innerHTML = "완료";
                    const input = document.createElement("input");
                    input.type = "text";
                    input.value = label.innerHTML;
                    input.className = "form-control d-inline w-50 me-2 ms-2";

                    li.replaceChild(input, label);
                    li.replaceChild(btnSuccess, btnUpdate);
                    input.focus();

                    btnSuccess.addEventListener("click", () => {
                            label.innerHTML = input.value;
                            li.replaceChild(label, input); // 다시 바꿈
                            li.replaceChild(btnUpdate, btnSuccess);
                            // 배열과 로컬스토리지 업데이트
                            for(let i = 0; i < toDoList.length; i++){
                                if(toDoList[i].liid == li.id){
                                    toDoList[i].text = input.value;
                                    localStorage.setItem("toDoList", JSON.stringify(toDoList));
                                }
                            }
                    });
                });
                
                //삭제버튼 이벤트 등록
                btnDelete.addEventListener("click", () => {
					if(confirm("삭제 하시겠습니까?")){
						// toDoList에서 해당 아이템 제거
	                    for (let i = 0; i < toDoList.length; i++) {
	                        if (toDoList[i].liid == li.id) {
	                            toDoList.splice(i, 1); // 배열에서 제거(i번 인덱스부터 1개 삭제한다는 뜻)
	                            break;
	                        }
	                    }
	                    // 로컬스토리지 갱신
	                    localStorage.setItem("toDoList", JSON.stringify(toDoList));
	                    writeToDo(); // 다시 화면 그리기
					}
                });
        
                // 체크박스 이벤트 등록
                checkBox.addEventListener("change", (event) => {
                    const checked = event.target.checked;
        
                    for(let i = 0; i < toDoList.length; i++){
                        if(toDoList[i].liid == li.id){
                            toDoList[i].done = checked;
                            localStorage.setItem("toDoList", JSON.stringify(toDoList));
                        }
                    }
        
                    if(checked){
                        label.style.color = "gray";
                        label.style.textDecoration = "line-through";
                    } else {
                        label.style.color = "";
                        label.style.textDecoration = "";
                    }
                });
            });
        
            content.appendChild(ul);
        }
    	
    	// 이벤트 등록
        document.addEventListener("DOMContentLoaded", function() { // HTML 구조만 읽으면 바로 실행
            writeToDo(); // 화면 뿌리기
        });
    	
        
		// 이벤트 등록 - 추가 버튼 클릭 시 실행
        btnAdd.addEventListener("click",() => {
        	if(inputListItem.value.trim() === ""){ // 값이 없으면 
				alert("할일을 작성해주세요.");
				return;
			}
        	
        	const createTime = Date.now();
        	// 객체배열에 저장
        	toDoList.push({liid: createTime, text: inputListItem.value, done: false}); // done은 체크박스 상태
        	
        	//로컬스토리지에 저장 - JS객체(키와 값 쌍으로 구성, 값에는 숫자,문자열,다른객체,배열,함수 등 가능)
        	//JSON은 자바스크립트객체를 문자열로 표현한 것
        	localStorage.setItem("toDoList",JSON.stringify(toDoList));
        	inputListItem.value = "";
        	writeToDo();// 화면 뿌리기
        });
		
		
		
    </script>
</body>
</html>